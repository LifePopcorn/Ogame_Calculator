<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>OGame Калькулятор</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --accent:#3a7bd5; --metal:#c9aa4a; --crystal:#7ad1ff; --deut:#9be78f; --try-color:#1877f2; }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial,Helvetica,sans-serif; font-size:12px; color:#e6edf3;
      background:url("images/wallpaper.jpg") center/cover no-repeat fixed; -webkit-font-smoothing:antialiased;
    }
    .theme-dark { --accent:#3a7bd5; color:#e6edf3; }

    .table-wrapper{ position:absolute; left:50px; top:50px; padding:8px; max-width:calc(100vw - 80px); transform-origin:center top; user-select:none; touch-action:none; }
    .header-bar{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .drag-handle{ padding:6px 8px; border-radius:6px; border:1px solid var(--accent); background:rgba(58,123,213,0.12); cursor:grab; color:#cfe0ff; user-select:none; }
    .tab-switch{ display:flex; gap:6px; align-items:center; }
    .tab-btn{ padding:6px 10px; background:#444; color:#fff; border-radius:6px; border:1px solid #999; cursor:pointer; }
    .tab-btn.active{ background:var(--accent); }
    .right-controls{ display:flex; gap:8px; align-items:center; }

    .lang-switch{ display:flex; gap:6px; align-items:center; }
    .lang-btn{ padding:6px 8px; background:#444; color:#fff; border-radius:6px; border:1px solid #999; cursor:pointer; }
    .lang-btn.active{ background:var(--accent); }

    .box-row{ display:flex; gap:12px; align-items:center; padding:6px; border-radius:8px; background:rgba(24,28,36,0.92); margin:0; border:1px solid rgba(255,255,255,0.05); }
    .box-row .label{ display:flex; gap:8px; align-items:center; font-weight:700; color:#dfeefe; }
    .box-row .info{ color:#cfe0ff; font-weight:600; margin-left:8px; display:flex; gap:10px; align-items:center; }

    .table-frame{ margin-top:0; padding:8px; border-radius:10px; background:linear-gradient(180deg, rgba(20,24,32,0.97), rgba(10,12,18,0.97)); border:2px solid #253041; outline:1px solid rgba(255,255,255,0.05); box-shadow: 0 8px 20px rgba(0,0,0,0.55), inset 0 0 8px rgba(255,255,255,0.04); display:flex; flex-direction:column; }

    .cost-table{ width:100%; border-collapse:collapse; margin-top:6px; flex:0 0 auto; border:1px solid rgba(255,255,255,0.08); border-radius:8px; overflow:hidden; background:rgba(18,22,30,0.7); }
    .cost-table thead th{ background:#2b313b; color:#cfe0ff; white-space:nowrap; border-bottom:1px solid rgba(255,255,255,0.08); }
    .cost-table th, .cost-table td{ padding:6px 8px; border:1px solid #29323d; font-size:12px; vertical-align:middle; }
    .cost-table td:first-child, .cost-table th:first-child{ text-align:left; width:220px; padding-left:10px; }

    .lvl-input, .planet-input, input[type="text"]{ padding:3px 6px; border-radius:4px; background:#0f1217; border:1px solid #4a5562; color:#e6edf3; height:22px; font-size:12px; }
    .planet-input{ width:80px; } .lvl-input{ width:70px; }

    .icon{ width:20px; height:20px; vertical-align:middle; margin-right:6px; }
    .icon-dm{ width:26px; height:26px; margin:0 6px 0 0; display:inline-block; vertical-align:middle; }

    .tm-block{ display:flex; align-items:center; gap:4px; padding:2px; border-radius:8px; background:rgba(24,28,36,0.92); margin:0; max-width:420px; border:1px solid rgba(255,255,255,0.06); }

    .delivery{ margin-top:8px; padding:8px; border-radius:8px; background:rgba(24,28,36,0.95); border:1px solid rgba(255,255,255,0.06); display:flex; flex-direction:column; gap:8px; align-items:flex-start; }
    .delivery .blk{ display:block; width:100%; }
    .delivery .blk.inline{ display:flex; gap:8px; align-items:center; }

    .tab-content{ display:none; } .tab-content.active{ display:block; }

    #shipsTable th, #shipsTable td { padding:4px 6px; font-size:12px; }
    #shipsTable td:first-child { width:160px; padding-left:8px; }

    .planet-single-row{ display:flex; gap:12px; align-items:center; margin-top:8px; }
    .planet-field{ display:flex; align-items:center; gap:6px; }
    .row-deficit{ background:rgba(255,0,0,0.15); }
    .ship-name{ font-weight:600; color:inherit; font-size:12px; }

    .icon-fallback{ display:inline-block; width:20px; height:20px; line-height:20px; text-align:center; margin-right:6px; opacity:0.9; font-size:13px; vertical-align:middle; }

    .global-zoom { position: fixed; top:12px; right:12px; z-index:10000; display:flex; gap:8px; background: rgba(10,12,18,0.6); padding:6px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); backdrop-filter: blur(6px); }
    .global-zoom button { padding:8px 10px; border-radius:6px; background:#222; color:#fff; border:1px solid #666; cursor:pointer; font-weight:700; }

    .val-metal { color: var(--metal); font-weight:700; }
    .val-crystal { color: var(--crystal); font-weight:700; }
    .val-deut { color: var(--deut); font-weight:700; }

    .try-value { color: var(--try-color); font-weight:800; }
    .tm-left {
      font-weight: 800;
      background: linear-gradient(90deg, #41c879, #00e0ff, #ff00ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @media (max-width:640px){
      .table-wrapper{ left:12px; top:12px; right:12px; position:relative; transform:none; }
      .header-bar{ flex-wrap:wrap; }
      .tab-switch{ width:100%; justify-content:center; order:2; }
      .right-controls{ order:1; width:100%; justify-content:flex-end; }
      .global-zoom{ top:auto; bottom:12px; right:12px; }
      .box-row{ flex-direction:column; align-items:flex-start; gap:8px; }
    }
  </style>
</head>
<body class="theme-dark">
  <div class="table-wrapper" id="tableWrapper" role="region" aria-label="OGame калькулятор" tabindex="-1">

    <div class="header-bar">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="drag-handle" id="dragHandle" tabindex="0" role="button" aria-label="Переместить таблицу">Переместить таблицу</div>
        <div class="tab-switch" role="tablist">
          <button class="tab-btn active" data-tab="buildings" aria-selected="true" data-i18n="tabBuildings">Постройки</button>
          <button class="tab-btn" data-tab="research" aria-selected="false" data-i18n="tabResearch">Исследования</button>
          <button class="tab-btn" data-tab="fleet" aria-selected="false" data-i18n="tabFleet">Флот</button>
        </div>
      </div>

      <div class="right-controls">
        <div class="lang-switch" role="toolbar" aria-label="Language">
          <button class="lang-btn" id="langRU" aria-pressed="false">RU</button>
          <button class="lang-btn" id="langTR" aria-pressed="false">TR</button>
        </div>
      </div>
    </div>

    <div class="box-row" id="globalBoxRow">
      <label class="label" id="lblBoxes"><img src="images/metal_box.png" class="icon" alt=""> <span data-i18n="boxesLabel">Коробка с металлом</span></label>
      <input id="boxesCount" class="lvl-input" type="text" inputmode="numeric" placeholder="Кол-во коробок" style="width:110px">
      <input id="boxValue" class="lvl-input" type="text" inputmode="numeric" placeholder="Металла в 1 коробке" style="width:160px">
      <div class="info">
        <span data-i18n="needOpen">Нужно открыть:</span>
        <span id="boxesNeeded" aria-live="polite">0</span>
        <span data-i18n="boxes">коробок</span>
        <div id="boxesCostTL" class="try-value" aria-live="polite">TRY: —</div>
      </div>
    </div>

    <div id="tabBuildings" class="tab-content active" role="tabpanel" aria-hidden="false">
      <div class="table-frame">
        <table class="cost-table" id="buildingsTable" aria-describedby="buildingsDesc">
          <caption id="buildingsDesc" style="position:absolute;left:-9999px;">Таблица подсчета ресурсов для построек</caption>
          <thead>
            <tr>
              <th data-key="building"><span class="data-key-label" data-i18n="building">Постройка</span></th>
              <th data-key="from"><span class="data-key-label" data-i18n="from">От</span></th>
              <th data-key="to"><span class="data-key-label" data-i18n="to">До</span></th>
              <th data-key="planets"><img src="images/planet.png" class="icon" alt=""><span class="data-key-label" data-i18n="planets">Планеты</span></th>
              <th data-key="metal"><img src="images/metal.png" class="icon" alt=""><span class="data-key-label" data-i18n="metal">Металл</span></th>
              <th data-key="crystal"><img src="images/crystal.png" class="icon" alt=""><span class="data-key-label" data-i18n="crystal">Кристалл</span></th>
              <th data-key="deut"><img src="images/deuterium.png" class="icon" alt=""><span class="data-key-label" data-i18n="deut">Дейтерий</span></th>
              <th data-key="points"><span class="data-key-label" data-i18n="points">Очки</span></th>
            </tr>
          </thead>
          <tbody id="tbodyBuildings"></tbody>
          <tfoot>
            <tr>
              <td><span class="data-key-label" data-i18n="total">Итого</span></td><td></td><td></td><td></td>
              <td id="sumMetalB" aria-live="polite"><span class="val-metal">0</span></td>
              <td id="sumCrystalB" aria-live="polite"><span class="val-crystal">0</span></td>
              <td id="sumDeutB" aria-live="polite"><span class="val-deut">0</span></td>
              <td id="sumPointsB" aria-live="polite">0</td>
            </tr>
            <tr>
              <td colspan="4" class="data-key-label" data-i18n="totalInMetal">Всего в металле</td>
              <td colspan="4" id="sumTotalMetalB" aria-live="polite">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div id="tabResearch" class="tab-content" role="tabpanel" aria-hidden="true">
      <div class="table-frame">
        <div class="tm-block" id="tmBlock">
          <img src="images/dm.png" class="icon-dm" alt="DM">
          <input id="tmInput" type="number" class="lvl-input" placeholder="0" min="0" step="1">
          <span id="tmTotal" aria-live="polite">Итого: <span class="tm-gradient">0</span></span>
        </div>

        <table class="cost-table" id="researchTable" aria-describedby="researchDesc">
          <caption id="researchDesc" style="position:absolute;left:-9999px;">Таблица подсчета ресурсов для исследований</caption>
          <thead>
            <tr>
              <th data-key="research"><span class="data-key-label" data-i18n="research">Исследование</span></th>
              <th data-key="from"><span class="data-key-label" data-i18n="from">От</span></th>
              <th data-key="to"><span class="data-key-label" data-i18n="to">До</span></th>
              <th data-key="metal"><img src="images/metal.png" class="icon" alt=""><span class="data-key-label" data-i18n="metal">Металл</span></th>
              <th data-key="crystal"><img src="images/crystal.png" class="icon" alt=""><span class="data-key-label" data-i18n="crystal">Кристалл</span></th>
              <th data-key="deut"><img src="images/deuterium.png" class="icon" alt=""><span class="data-key-label" data-i18n="deut">Дейтерий</span></th>
              <th data-key="points"><span class="data-key-label" data-i18n="points">Очки</span></th>
            </tr>
          </thead>
          <tbody id="tbodyResearch"></tbody>
          <tfoot>
            <tr>
              <td><span class="data-key-label" data-i18n="total">Итого</span></td><td></td><td></td>
              <td id="sumMetalR" aria-live="polite"><span class="val-metal">0</span></td>
              <td id="sumCrystalR" aria-live="polite"><span class="val-crystal">0</span></td>
              <td id="sumDeutR" aria-live="polite"><span class="val-deut">0</span></td>
              <td id="sumPointsR" aria-live="polite">0</td>
            </tr>
            <tr>
              <td colspan="3" class="data-key-label" data-i18n="totalInMetal">Всего в металле</td>
              <td colspan="4" id="sumTotalMetalR" aria-live="polite">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div id="tabFleet" class="tab-content" role="tabpanel" aria-hidden="true">
      <div class="table-frame" id="fleetFrame">
        <table class="cost-table" id="shipsTable" aria-describedby="fleetDesc">
          <caption id="fleetDesc" style="position:absolute;left:-9999px;">Таблица расчета ресурсов для флота</caption>
          <thead>
            <tr>
              <th id="thShip" data-i18n="ship">Корабль</th>
              <th id="thMetal"><img src="images/metal.png" class="icon" alt=""> <span data-i18n="metal">Металл</span></th>
              <th id="thCrystal"><img src="images/crystal.png" class="icon" alt=""> <span data-i18n="crystal">Кристалл</span></th>
              <th id="thDeut"><img src="images/deuterium.png" class="icon" alt=""> <span data-i18n="deut">Дейтерий</span></th>
              <th id="thQty" data-i18n="qty">Количество</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tr><td colspan="5" style="padding:0; border-top:1px solid #29323d;"></td></tr>
        </table>

        <div class="planet-single-row" style="margin-top:10px;">
          <div id="planetLabel" style="display:flex;align-items:center;gap:8px;"><img src="images/planet.png" class="icon" alt=""> <span data-i18n="planetResources">Ресурсы на планете</span></div>
          <div class="planet-field"><img src="images/metal.png" class="icon" alt="Металл"><input id="planetMetal" class="lvl-input" type="text" inputmode="numeric" placeholder="Металл" style="width:120px"></div>
          <div class="planet-field"><img src="images/crystal.png" class="icon" alt="Кристалл"><input id="planetCrystal" class="lvl-input" type="text" inputmode="numeric" placeholder="Кристалл" style="width:120px"></div>
          <div class="planet-field"><img src="images/deuterium.png" class="icon" alt="Дейтерий"><input id="planetDeut" class="lvl-input" type="text" inputmode="numeric" placeholder="Дейтерий" style="width:120px"></div>
        </div>

        <div class="delivery" aria-live="polite" id="fleetDelivery" style="display:none;">
          <div class="blk" id="deliveryTotalsBlock" style="display:flex;" aria-live="polite">
            <div style="font-weight:700" data-i18n="deliveryTotals">Итого по ресурсам:</div>
            <div style="margin-left:8px;"><span id="totalRes">0 Металл, 0 Кристалл, 0 Дейтерий</span></div>
          </div>

          <div class="blk" id="deliveryMetalEqBlock" style="display:flex;" aria-live="polite">
            <div style="font-weight:700" data-i18n="metalEq">Эквивалент в металле:</div>
            <div style="margin-left:8px;"><span id="totalMetalEq">0</span></div>
          </div>

          <div class="blk" id="deliveryGrandBlock" style="display:flex;" aria-live="polite">
            <div style="font-weight:700" data-i18n="grandAfter">Остаток после вычета:</div>
            <div style="margin-left:8px;"><span id="grandTotal">0</span></div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <div class="global-zoom" id="globalZoom" aria-hidden="false">
    <button id="globalZoomIn" title="Приблизить">+</button>
    <button id="globalZoomOut" title="Отдалить">−</button>
    <button id="globalZoomReset" title="Сброс и центр">⤢</button>
  </div>

  <script>
(function(){
  const CONFIG = {
    TM_PER_BOX: 42000,
    TM_PACKS: [{ tm:12500000, priceTRY:900 }],
    METAL_EQ_CRYSTAL: 1.5,
    METAL_EQ_DEUT: 3,
    MAX_LEVEL_SPAN: 1000,
    TM_PER_LEVEL_FACTOR: 2
  };

  const LANG = {
    ru: {
      tmLabel:"Тёмная материя",
      totalTMLabel:"Итого: ",
      tabBuildings:"Постройки",
      tabResearch:"Исследования",
      tabFleet:"Флот",
      locale:"ru-RU",
      unitMT:"МТ",
      unitBT:"БТ",
      boxesLabel:"Коробка с металлом",
      needOpen:"Нужно открыть:",
      boxes:"коробок",
      building:"Постройка",
      from:"От",
      to:"До",
      planets:"Планеты",
      metal:"Металл",
      crystal:"Кристалл",
      deut:"Дейтерий",
      points:"Очки",
      total:"Итого",
      totalInMetal:"Всего в металле",
      research:"Исследование",
      ship:"Корабль",
      qty:"Количество",
      planetResources:"Ресурсы на планете",
      deliveryTotals:"Итого по ресурсам:",
      metalEq:"Эквивалент в метале:",
      grandAfter:"Остаток после вычета:",
      leftoverLabel:"Остаток ТМ",
      boxesCountPh: "Кол-во коробок",
      boxValuePh: "Металла в 1 коробке"
    }, tr: {
      tmLabel:"Karanlık Madde",
      totalTMLabel:"Toplam: ",
      tabBuildings:"Binalar",
      tabResearch:"Araştırmalar",
      tabFleet:"Filo",
      locale:"tr-TR",
      unitMT:"Metal",
      unitBT:"BT",
      boxesLabel:"Metal Paketi",
      needOpen:"Açılmalı:",
      boxes:"kutu",
      building:"Bina",
      from:"Başlangıç",
      to:"Hedef",
      planets:"Gezegenler",
      metal:"Metal",
      crystal:"Kristal",
      deut:"Deuterium",
      points:"Puan",
      total:"Toplam",
      totalInMetal:"Metalde toplam",
      research:"Araştırma",
      ship:"Gemi",
      qty:"Adet",
      planetResources:"Gezegendeki kaynaklar",
      deliveryTotals:"Toplam kaynaklar:",
      metalEq:"Metale eşdeğer:",
      grandAfter:"Kısıtlamadan sonra kalan:",
      leftoverLabel:"Kalan KM",
      boxesCountPh: "Kutu sayısı",
      boxValuePh: "Metalin bir günlük üretimi"
    }
  };

  const BUILDINGS_DATA = [ { base:{m:60,c:15,d:0}, factor:1.5 }, { base:{m:48,c:24,d:0}, factor:1.6 }, { base:{m:225,c:75,d:0}, factor:1.5 }, { base:{m:75,c:30,d:0}, factor:1.5 }, { base:{m:900,c:360,d:180}, factor:1.8 }, { base:{m:400,c:120,d:200}, factor:2.0 }, { base:{m:1000000,c:500000,d:100000}, factor:2.0 }, { base:{m:400,c:200,d:100}, factor:2.0 }, { base:{m:2000,c:0,d:0}, factor:2.0 }, { base:{m:2000,c:1000,d:0}, factor:2.0 }, { base:{m:2000,c:2000,d:0}, factor:2.0 }, { base:{m:200,c:400,d:200}, factor:2.0 }, { base:{m:50000,c:100000,d:0}, factor:2.0 }, { base:{m:20000,c:40000,d:0}, factor:2.0 }, { base:{m:200,c:0,d:50}, factor:2.0 }, { base:{m:20000,c:20000,d:0}, factor:2.0 } ];

  const RESEARCH_DATA = [ { base:{m:200,c:1000,d:200}, factor:2.0 }, { base:{m:0,c:400,d:600}, factor:2.0 }, { base:{m:800,c:200,d:0}, factor:2.0 }, { base:{m:200,c:600,d:0}, factor:2.0 }, { base:{m:1000,c:0,d:0}, factor:2.0 }, { base:{m:0,c:800,d:400}, factor:2.0 }, { base:{m:0,c:4000,d:2000}, factor:2.0 }, { base:{m:400,c:0,d:600}, factor:2.0 }, { base:{m:2000,c:4000,d:600}, factor:2.0 }, { base:{m:10000,c:20000,d:6000}, factor:2.0 }, { base:{m:200,c:100,d:0}, factor:2.0 }, { base:{m:1000,c:300,d:100}, factor:2.0 }, { base:{m:2000,c:4000,d:1000}, factor:2.0 }, { base:{m:240000,c:400000,d:160000}, factor:2.0 }, { base:{m:4000,c:8000,d:4000}, factor:1.75 }, { base:{m:0,c:0,d:0}, factor:3.0 } ];

  const shipList = [
    { id:"small_cargo", ru:"Малый транспорт", tr:"Küçük Nakliye", metal:2000, crystal:2000, deut:0, img:"maly_transport.png" },
    { id:"large_cargo", ru:"Большой транспорт", tr:"Büyük Nakliye", metal:6000, crystal:6000, deut:0, img:"bolshoy_transport.png" },
    { id:"light_fighter", ru:"Лёгкий истребитель", tr:"Hafif Avcı", metal:3000, crystal:1000, deut:0, img:"legkiy_istrebitel.png" },
    { id:"heavy_fighter", ru:"Тяжёлый истребитель", tr:"Ağır Avcı", metal:6000, crystal:4000, deut:0, img:"tyazhely_istrebitel.png" },
    { id:"cruiser", ru:"Крейсер", tr:"Kruvazör", metal:20000, crystal:7000, deut:2000, img:"kreiser.png" },
    { id:"battleship", ru:"Линкор", tr:"Komuta Gemisi", metal:45000, crystal:15000, deut:0, img:"linkor.png" },
    { id:"battlecruiser", ru:"Линейный крейсер", tr:"Fırkateyn", metal:30000, crystal:40000, deut:15000, img:"battlecruiser.png" },
    { id:"bomber", ru:"Бомбардировщик", tr:"Bombardıman Gemisi", metal:50000, crystal:25000, deut:15000, img:"bombardirovshik.png" },
    { id:"destroyer", ru:"Уничт", tr:"Muhrip", metal:60000, crystal:50000, deut:15000, img:"unichtozhitel.png" },
    { id:"zhnec", ru:"Жнец", tr:"Azrail", metal:85000, crystal:55000, deut:20000, img:"zhnec.png" },
    { id:"pathfinder", ru:"Первопроходец", tr:"Rehber", metal:8000, crystal:15000, deut:8000, img:"pathfinder.png" }
  ];

  const BUILDING_NAMES = { ru:["Рудник по добыче металла","Рудник по добыче кристалла","Синтезатор дейтерия","Солнечная электростанция","Термоэлектростанция","Фабрика роботов","Фабрика нанитов","Верфь","Хранилище металла","Хранилище кристалла","Хранилище дейтерия","Исслед-кая лаборатория","Терраформер","Склад альянса","Космический док","Ракетный док"], tr:["Metal Madeni","Kristal Madeni","Deuterium Sentezleyici","Solar Enerji Santrali","Füzyon Santrali","Robot Fabrikası","Nanite Fabrikası","Tersane","Metal Deposu","Kristal Deposu","Deuterium Tankeri","Bilimsel Araştırma Laboratuvarı","Terraformer","İttifak Deposu","Uzay İskelesi","Roket Silosu"] };

  const RESEARCH_NAMES = { ru:["Шпионаж","Компьютерная технология","Оружейная технология","Щитовая технология","Технология брони","Энергетическая технология","Гипер-нная технология","Двигатели горения","Импульсный двигатель","Гипер-нный двигатель","Лазерная технология","Ионная технология","Плазменная технология","Галактическая сеть","Астрофизика","Гравитационные исследования"], tr:["Casusluk Tekniği","Bilgisayar Teknolojisi","Silah Teknolojisi","Koruyucu Kalkan Tekniği","Uzay Gemisi Zırhlandırması","Enerji Tekniği","Hiperuzay Tekniği","Yanmalı Motor","İtki Motoru","Hiperuzay İticisi","Lazer Tekniği","İyon Tekniği","Plazma Tekniği","Galaksiler Arası Araştırma Ağı","Astrofizik","Gravitasyon Araştırması"] };

  const KEYS = {
    LANG: 'og_calc_lang_v2',
    TRANSFORM: 'og_calc_transform_v2',
    INPUTS_BUILD: 'og_calc_inputs_build_v2',
    INPUTS_RESEARCH: 'og_calc_inputs_research_v2',
    TM: 'og_calc_tm_v2',
    BOXES: 'og_calc_boxes_v2',
    SHIP_QTY: 'og_calc_ship_qty_v2',
    ACTIVE_TAB: 'og_calc_active_tab_v2'
  };

  // state initialization
  const state = {
    lang: (function(){ try { const raw = localStorage.getItem(KEYS.LANG); return raw ? JSON.parse(raw) : 'ru'; } catch(e){ return 'ru'; } })(),
    transform: { scale:1, posX:0, posY:0 },
    tmPrice: 0,
    activeTab: (function(){ try { const raw = localStorage.getItem(KEYS.ACTIVE_TAB); return raw ? JSON.parse(raw) : 'buildings'; } catch(e){ return 'buildings'; } })()
  };

  // DOM
  const tbodyB = document.getElementById('tbodyBuildings');
  const tbodyR = document.getElementById('tbodyResearch');
  const tmInput = document.getElementById('tmInput');
  const tmTotal = document.getElementById('tmTotal');
  const wrapperEl = document.getElementById('tableWrapper');
  const boxesNeededEl = document.getElementById('boxesNeeded');
  const boxesCountInput = document.getElementById('boxesCount');
  const boxValueInput = document.getElementById('boxValue');
  const boxesCostTLEl = document.getElementById('boxesCostTL');

  // helper utils
  function formatNumber(n){
    if (n === null || n === undefined || isNaN(n)) return '0';
    const sign = n < 0 ? '-' : '';
    n = Math.round(Math.abs(Number(n)));
    const s = String(n);
    if (s.length <= 3) return sign + s;
    const parts = [];
    for (let i = s.length; i > 0; i -= 3) {
      const start = Math.max(0, i - 3);
      parts.unshift(s.slice(start, i));
    }
    return sign + parts.join('.');
  }

  function toNumberSafe(v, def = 0){
    if (v === null || v === undefined) return def;
    if (typeof v === 'number') return Number.isFinite(v) ? v : def;
    const s = String(v).trim();
    if (s === '' || s === '-') return def;
    const cleaned = s.replace(/[^0-9\-]/g,'');
    if (cleaned === '' || cleaned === '-') return def;
    const n = parseInt(cleaned, 10);
    return Number.isFinite(n) ? n : def;
  }

  function saveToLS(key, value){ try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){} }
  function loadFromLS(key, fallback){ try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch(e){ return fallback; } }

  function geomSum(base, factor, from, to){
    const len = Math.max(0, to - from);
    if(len <= 0) return { m:0,c:0,d:0, points:0, levels:0 };
    const expoStart = Math.max(0, from);
    const count = len;
    const sum = (b) => {
      if (b === 0 || count === 0) return 0;
      if (factor === 1) return b * count * Math.pow(factor, expoStart);
      return b * Math.pow(factor, expoStart) * (Math.pow(factor, count) - 1) / (factor - 1);
    };
    const m = Math.round(sum(base.m));
    const c = Math.round(sum(base.c));
    const d = Math.round(sum(base.d));
    const points = Math.round((m + c + d) / 1000);
    return { m, c, d, points, levels: count };
  }

  function createSpanWithClass(cls, text){
    const sp = document.createElement('span');
    sp.className = cls;
    sp.textContent = formatNumber(text);
    return sp;
  }

  function formatSpanMetalAppend(targetEl, n){
    if(!targetEl) return;
    targetEl.textContent = '';
    targetEl.appendChild(createSpanWithClass('val-metal', n));
  }
  function formatSpanCrystalAppend(targetEl, n){
    if(!targetEl) return;
    targetEl.textContent = '';
    targetEl.appendChild(createSpanWithClass('val-crystal', n));
  }
  function formatSpanDeutAppend(targetEl, n){
    if(!targetEl) return;
    targetEl.textContent = '';
    targetEl.appendChild(createSpanWithClass('val-deut', n));
  }

  const ICONS_BUILDINGS = [ "metal_mine.png","crystal_mine.png","deuterium_synth.png","solar_plant.png","fusion_plant.png","robot_factory.png","nanite_factory.png","shipyard.png","metal_storage.png","crystal_storage.png","deuterium_tank.png","research_lab.png","terraformer.png","alliance_depot.png","dock.png","missile_silo.png" ];
  const ICONS_RESEARCH = [ "spy.png","computer.png","weapons.png","shield.png","armor.png","energy.png","hyperspace.png","combustion.png","impulse.png","hyperdrive.png","laser.png","ion.png","plasma.png","irn.png","astro.png","graviton.png" ];

  function createImageFallback(){
    const span = document.createElement('span');
    span.className = 'icon-fallback';
    span.textContent = '🛠';
    return span;
  }

  // register formatting for a single input (used instead of global attach for selector-heavy cases)
  function registerInputFormatting(inp){
    if(!inp || inp._thousandsBound) return;
    inp._thousandsBound = true;

    function formatWithDotsRaw(inputStr){
      if(inputStr === null || inputStr === undefined) return '';
      const s = String(inputStr);
      const sign = s[0] === '-' ? '-' : '';
      const digits = (sign ? s.slice(1) : s).replace(/[^0-9]/g, '');
      if(digits.length === 0) return sign ? '-' : '';
      let out = '';
      for(let i = digits.length; i > 0; i -= 3){
        const start = Math.max(0, i - 3);
        out = digits.slice(start, i) + (out ? '.' + out : '');
      }
      return sign + out;
    }

    inp.addEventListener('input', function(){
      const el = this;
      const raw = el.value;
      const selStart = el.selectionStart || 0;
      let left = raw.slice(0, selStart).replace(/[^0-9\-]/g, '');
      const leftDigitsCount = (left[0] === '-' ? left.slice(1) : left).length;
      const formatted = formatWithDotsRaw(raw);
      el.value = formatted;

      let digitsSeen = 0;
      let newPos = 0;
      for(let i=0;i<formatted.length;i++){
        if(/\d/.test(formatted[i])) digitsSeen++;
        newPos++;
        if(digitsSeen >= leftDigitsCount) break;
      }
      try{ el.setSelectionRange(newPos, newPos); }catch(e){}
    });

    inp.addEventListener('blur', function(){
      const v = this.value;
      if (v === '' || v === '-') { this.value = ''; return; }
      const num = toNumberSafe(v, 0);
      this.value = num === 0 ? '' : formatNumber(num);
      this.dispatchEvent(new Event('change', { bubbles: true }));
    });

    inp.addEventListener('keydown', function(e){
      const allowed = ['Backspace','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Delete','Tab','Home','End'];
      if (e.ctrlKey || e.metaKey) return;
      if(allowed.indexOf(e.key) !== -1) return;
      if(e.key >= '0' && e.key <= '9') return;
      if(e.key === '-' || e.key === '.' || e.key === ',') return;
      e.preventDefault();
    });

    inp.addEventListener('paste', function(e){
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData)?.getData('text') || '';
      const cleanedChunk = (function(t){
        const digits = t.replace(/[^0-9\-]/g,'');
        return digits;
      })(text);
      const start = this.selectionStart || 0;
      const end = this.selectionEnd || start;
      const before = this.value.slice(0, start);
      const after = this.value.slice(end);
      const nextRaw = before + cleanedChunk + after;
      const next = (function(s){
        const digits = s.replace(/[^0-9\-]/g,'');
        const sign = digits[0] === '-' ? '-' : '';
        const d = sign ? digits.slice(1) : digits;
        let out = '';
        for(let i = d.length; i > 0; i -= 3){
          const st = Math.max(0, i - 3);
          out = d.slice(st, i) + (out ? '.' + out : '');
        }
        return sign + out;
      })(nextRaw);
      this.value = next;

      const caretTargetDigits = (before + cleanedChunk).replace(/[^0-9]/g,'').length;
      let pos = 0, seen = 0;
      while (pos < next.length && seen < caretTargetDigits) { if (/\d/.test(next[pos])) seen++; pos++; }
      try { this.setSelectionRange(pos, pos); } catch {}
      this.dispatchEvent(new Event('change', { bubbles: true }));
    });
  }

  // attach formatting to multiple selectors (only those that exist)
  function attachLiveThousandsFormatting(selector){
    const nodes = Array.prototype.slice.call(document.querySelectorAll(selector || ''));
    nodes.forEach(registerInputFormatting);
  }

  // build rows: create elements and register formatting for created inputs
  function buildRowsBuildings(){
    tbodyB.innerHTML='';
    const names = BUILDING_NAMES[state.lang] || BUILDING_NAMES.ru;
    names.forEach((name,i)=>{
      const tr=document.createElement('tr');
      tr.dataset.index=i;

      const tdName = document.createElement('td');
      tdName.className = 'name-cell';
      if(ICONS_BUILDINGS[i]){
        const img = document.createElement('img');
        img.src = "images/" + ICONS_BUILDINGS[i];
        img.className = 'icon';
        img.alt = '';
        img.addEventListener('error', ()=>{
          if(!img._fallback){ const fb=createImageFallback(); img.style.display='none'; img.parentNode && img.parentNode.insertBefore(fb,img.nextSibling); img._fallback=true; }
        });
        tdName.appendChild(img);
      }
      tdName.appendChild(document.createTextNode(name));
      tr.appendChild(tdName);

      const tdFrom = document.createElement('td');
      const inFrom = document.createElement('input');
      inFrom.type='text'; inFrom.className='lvl-input'; inFrom.dataset.type='from'; inFrom.dataset.index = String(i); inFrom.inputMode='numeric';
      tdFrom.appendChild(inFrom); tr.appendChild(tdFrom);

      const tdTo = document.createElement('td');
      const inTo = document.createElement('input');
      inTo.type='text'; inTo.className='lvl-input'; inTo.dataset.type='to'; inTo.dataset.index = String(i); inTo.inputMode='numeric';
      tdTo.appendChild(inTo); tr.appendChild(tdTo);

      const tdPlanets = document.createElement('td');
      const picon = document.createElement('img'); picon.src='images/planet.png'; picon.className='icon'; picon.alt='';
      const inPlan = document.createElement('input'); inPlan.type='text'; inPlan.className='planet-input'; inPlan.dataset.type='planets'; inPlan.dataset.index=String(i); inPlan.inputMode='numeric'; inPlan.value='1';
      tdPlanets.appendChild(picon); tdPlanets.appendChild(inPlan); tr.appendChild(tdPlanets);

      const tdM = document.createElement('td'); tdM.className='m'; tdM.appendChild(createSpanWithClass('val-metal',0)); tr.appendChild(tdM);
      const tdC = document.createElement('td'); tdC.className='c'; tdC.appendChild(createSpanWithClass('val-crystal',0)); tr.appendChild(tdC);
      const tdD = document.createElement('td'); tdD.className='d'; tdD.appendChild(createSpanWithClass('val-deut',0)); tr.appendChild(tdD);
      const tdP = document.createElement('td'); tdP.className='p'; tdP.textContent = '0'; tr.appendChild(tdP);

      tbodyB.appendChild(tr);

      // register formatting for inputs created
      registerInputFormatting(inFrom);
      registerInputFormatting(inTo);
      registerInputFormatting(inPlan);
    });
  }

  function buildRowsResearch(){
    tbodyR.innerHTML='';
    const names = RESEARCH_NAMES[state.lang] || RESEARCH_NAMES.ru;
    names.forEach((name,i)=>{
      const tr=document.createElement('tr');
      tr.dataset.index=i;

      const tdName = document.createElement('td');
      tdName.className = 'name-cell';
      if(ICONS_RESEARCH[i]){
        const img = document.createElement('img');
        img.src = "images/" + ICONS_RESEARCH[i];
        img.className = 'icon';
        img.alt = '';
        img.addEventListener('error', ()=>{
          if(!img._fallback){ const fb=createImageFallback(); img.style.display='none'; img.parentNode && img.parentNode.insertBefore(fb,img.nextSibling); img._fallback=true; }
        });
        tdName.appendChild(img);
      }
      tdName.appendChild(document.createTextNode(name));
      tr.appendChild(tdName);

      const tdFrom = document.createElement('td');
      const inFrom = document.createElement('input');
      inFrom.type='text'; inFrom.className='lvl-input'; inFrom.dataset.type='from'; inFrom.dataset.index = String(i); inFrom.inputMode='numeric';
      tdFrom.appendChild(inFrom); tr.appendChild(tdFrom);

      const tdTo = document.createElement('td');
      const inTo = document.createElement('input');
      inTo.type='text'; inTo.className='lvl-input'; inTo.dataset.type='to'; inTo.dataset.index = String(i); inTo.inputMode='numeric';
      tdTo.appendChild(inTo); tr.appendChild(tdTo);

      const tdM = document.createElement('td'); tdM.className='m'; tdM.appendChild(createSpanWithClass('val-metal',0)); tr.appendChild(tdM);
      const tdC = document.createElement('td'); tdC.className='c'; tdC.appendChild(createSpanWithClass('val-crystal',0)); tr.appendChild(tdC);
      const tdD = document.createElement('td'); tdD.className='d'; tdD.appendChild(createSpanWithClass('val-deut',0)); tr.appendChild(tdD);
      const tdP = document.createElement('td'); tdP.className='p'; tdP.textContent = '0'; tr.appendChild(tdP);

      tbodyR.appendChild(tr);

      registerInputFormatting(inFrom);
      registerInputFormatting(inTo);
    });
  }

  function recalcRowBuildings(tr){
    const idx = Number(tr.dataset.index);
    const data = BUILDINGS_DATA[idx];
    const inpFrom = tr.querySelector('input[data-type="from"]');
    const inpTo = tr.querySelector('input[data-type="to"]');
    const inpPlan = tr.querySelector('input[data-type="planets"]');
    const from = toNumberSafe(inpFrom?.value, 0);
    const toVal = inpTo?.value;
    let to = toVal === '' ? from : toNumberSafe(toVal, from);
    to = Math.max(from, to);
    if (to - from > CONFIG.MAX_LEVEL_SPAN) to = from + CONFIG.MAX_LEVEL_SPAN;
    const planets = Math.max(1, toNumberSafe(inpPlan?.value, 1));
    const sum = geomSum(data.base, data.factor, from, to);
    const m = Math.round(sum.m * planets);
    const c = Math.round(sum.c * planets);
    const d = Math.round(sum.d * planets);
    const p = Math.round(sum.points * planets);
    const tdM = tr.querySelector('td.m'), tdC = tr.querySelector('td.c'), tdD = tr.querySelector('td.d'), tdP = tr.querySelector('td.p');
    formatSpanMetalAppend(tdM, m);
    formatSpanCrystalAppend(tdC, c);
    formatSpanDeutAppend(tdD, d);
    if(tdP) tdP.textContent = formatNumber(p);
    return { m, c, d, p };
  }

  function recalcRowResearch(tr){
    const idx = Number(tr.dataset.index);
    const data = RESEARCH_DATA[idx];
    const inpFrom = tr.querySelector('input[data-type="from"]');
    const inpTo = tr.querySelector('input[data-type="to"]');
    const from = toNumberSafe(inpFrom?.value, 0);
    const toVal = inpTo?.value;
    let to = toVal === '' ? from : toNumberSafe(toVal, from);
    to = Math.max(from, to);
    if (to - from > CONFIG.MAX_LEVEL_SPAN) to = from + CONFIG.MAX_LEVEL_SPAN;
    const sum = geomSum(data.base, data.factor, from, to);
    const m = sum.m;
    const c = sum.c;
    const d = sum.d;
    const p = sum.points;
    const tdM = tr.querySelector('td.m'), tdC = tr.querySelector('td.c'), tdD = tr.querySelector('td.d'), tdP = tr.querySelector('td.p');
    formatSpanMetalAppend(tdM, m);
    formatSpanCrystalAppend(tdC, c);
    formatSpanDeutAppend(tdD, d);
    if(tdP) tdP.textContent = formatNumber(p);
    return { m, c, d, p, levels: sum.levels };
  }

  function recalcAllBuildings(){
    let tm=0, tc=0, td=0, tp=0;
    tbodyB.querySelectorAll('tr').forEach(tr=>{ const r=recalcRowBuildings(tr); tm+=r.m; tc+=r.c; td+=r.d; tp+=r.p; });
    const elM = document.getElementById('sumMetalB'), elC = document.getElementById('sumCrystalB'), elD = document.getElementById('sumDeutB');
    formatSpanMetalAppend(elM, tm);
    formatSpanCrystalAppend(elC, tc);
    formatSpanDeutAppend(elD, td);
    document.getElementById('sumPointsB').textContent = formatNumber(tp);
    const totalMetal = Math.round(convertToMetal(tm,tc,td));
    document.getElementById('sumTotalMetalB').textContent = formatNumber(totalMetal);
    persistInputs('buildings');
    updateBoxesNeeded();
  }

  function recalcAllResearch(){
    let sm=0, sc=0, sd=0, sp=0, totalLevels=0;
    tbodyR.querySelectorAll('tr').forEach(tr=>{
      const r = recalcRowResearch(tr);
      sm += r.m; sc += r.c; sd += r.d; sp += r.p; totalLevels += r.levels || 0;
    });

    const elM = document.getElementById('sumMetalR'), elC = document.getElementById('sumCrystalR'), elD = document.getElementById('sumDeutR');
    formatSpanMetalAppend(elM, sm);
    formatSpanCrystalAppend(elC, sc);
    formatSpanDeutAppend(elD, sd);
    document.getElementById('sumPointsR').textContent = formatNumber(sp);

    const totalMetal = Math.round(convertToMetal(sm, sc, sd));
    document.getElementById('sumTotalMetalR').textContent = formatNumber(totalMetal);

    const perLevelRaw = (state.tmPrice && state.tmPrice > 0) ? state.tmPrice : toNumberSafe(tmInput?.value, 0);
    const perLevel = toNumberSafe(perLevelRaw, 0);
    const totalTM = Math.round(perLevel * totalLevels * CONFIG.TM_PER_LEVEL_FACTOR);

    // safe DOM update for tmTotal
    if(tmTotal){
      tmTotal.textContent = '';
      const label = document.createTextNode((LANG[state.lang].totalTMLabel || 'Итого: ') + ' ');
      const span = document.createElement('span');
      span.className = 'tm-gradient';
      span.textContent = formatNumber(totalTM);
      tmTotal.appendChild(label);
      tmTotal.appendChild(span);
    }

    if (tmInput) {
      const v = toNumberSafe(tmInput.value, 0);
      state.tmPrice = v;
      saveToLS(KEYS.TM, v);
    }

    persistInputs('research');
    updateBoxesNeeded();
  }

  function convertToMetal(m,c,d){ return m + c * CONFIG.METAL_EQ_CRYSTAL + d * CONFIG.METAL_EQ_DEUT; }

  function persistInputs(kind){
    if(kind === 'buildings'){
      const arr = [];
      tbodyB.querySelectorAll('tr').forEach(tr=>{
        arr.push({
          from: toNumberSafe(tr.querySelector('input[data-type="from"]')?.value, 0),
          to: toNumberSafe(tr.querySelector('input[data-type="to"]')?.value, 0),
          planets: toNumberSafe(tr.querySelector('input[data-type="planets"]')?.value, 1)
        });
      });
      saveToLS(KEYS.INPUTS_BUILD, arr);
    } else if(kind === 'research'){
      const arr = [];
      tbodyR.querySelectorAll('tr').forEach(tr=>{
        arr.push({
          from: toNumberSafe(tr.querySelector('input[data-type="from"]')?.value, 0),
          to: toNumberSafe(tr.querySelector('input[data-type="to"]')?.value, 0)
        });
      });
      saveToLS(KEYS.INPUTS_RESEARCH, arr);
    }
  }

  function persistBoxesAndPlanets(){
    const data = {
      boxesCount: toNumberSafe(boxesCountInput?.value, 0),
      boxValue: toNumberSafe(boxValueInput?.value, 0),
      planetMetal: toNumberSafe(document.getElementById('planetMetal')?.value, 0),
      planetCrystal: toNumberSafe(document.getElementById('planetCrystal')?.value, 0),
      planetDeut: toNumberSafe(document.getElementById('planetDeut')?.value, 0)
    };
    saveToLS(KEYS.BOXES, data);
  }

  function saveShipQuantities(){
    const qtyMap = {};
    document.querySelectorAll('input[data-id]').forEach(inp=>{
      qtyMap[inp.dataset.id] = toNumberSafe(inp.value, 0);
    });
    saveToLS(KEYS.SHIP_QTY, qtyMap);
  }

  function restoreAll(){
    const b = loadFromLS(KEYS.INPUTS_BUILD, null);
    if(Array.isArray(b)){
      tbodyB.querySelectorAll('tr').forEach((tr, i)=>{
        if(!b[i]) return;
        const f = tr.querySelector('input[data-type="from"]'), t = tr.querySelector('input[data-type="to"]'), p = tr.querySelector('input[data-type="planets"]');
        if(f) f.value = b[i].from ? formatNumber(b[i].from) : '';
        if(t) t.value = b[i].to ? formatNumber(b[i].to) : '';
        if(p) p.value = b[i].planets ? formatNumber(b[i].planets) : '1';
      });
    }
    const r = loadFromLS(KEYS.INPUTS_RESEARCH, null);
    if(Array.isArray(r)){
      tbodyR.querySelectorAll('tr').forEach((tr, i)=>{
        if(!r[i]) return;
        const f = tr.querySelector('input[data-type="from"]'), t = tr.querySelector('input[data-type="to"]');
        if(f) f.value = r[i].from ? formatNumber(r[i].from) : '';
        if(t) t.value = r[i].to ? formatNumber(r[i].to) : '';
      });
    }

    const boxes = loadFromLS(KEYS.BOXES, {});
    if(boxesCountInput && boxes.boxesCount != null) boxesCountInput.value = boxes.boxesCount ? formatNumber(boxes.boxesCount) : '';
    if(boxValueInput && boxes.boxValue != null) boxValueInput.value = boxes.boxValue ? formatNumber(boxes.boxValue) : '';
    if(document.getElementById('planetMetal') && boxes.planetMetal != null) document.getElementById('planetMetal').value = boxes.planetMetal ? formatNumber(boxes.planetMetal) : '';
    if(document.getElementById('planetCrystal') && boxes.planetCrystal != null) document.getElementById('planetCrystal').value = boxes.planetCrystal ? formatNumber(boxes.planetCrystal) : '';
    if(document.getElementById('planetDeut') && boxes.planetDeut != null) document.getElementById('planetDeut').value = boxes.planetDeut ? formatNumber(boxes.planetDeut) : '';

    const ships = loadFromLS(KEYS.SHIP_QTY, {});
    document.querySelectorAll('input[data-id]').forEach(inp=>{
      if(ships[inp.dataset.id] != null) inp.value = ships[inp.dataset.id] ? formatNumber(ships[inp.dataset.id]) : '';
    });

    const tmSaved = loadFromLS(KEYS.TM, null);
    if(tmSaved != null && tmInput) tmInput.value = tmSaved ? String(tmSaved) : '';

    const transform = loadFromLS(KEYS.TRANSFORM, null);
    if(transform && typeof transform.scale === 'number'){ state.transform = transform; window.scale = transform.scale; window.posX = transform.posX; window.posY = transform.posY; }

    const lang = loadFromLS(KEYS.LANG, null);
    if(lang) state.lang = lang;

    const atab = loadFromLS(KEYS.ACTIVE_TAB, null);
    if(atab) state.activeTab = atab;
  }

  // render fleet table using shipMap for fast lookup
  let shipMap = {};
  function buildShipMap(){ shipMap = Object.fromEntries(shipList.map(s => [s.id, s])); }

  function renderTable(){
    const tableBody = document.querySelector("#shipsTable tbody");
    if(!tableBody) return;
    const qtyMap = loadFromLS(KEYS.SHIP_QTY, {});
    tableBody.innerHTML='';
    shipList.forEach(ship=>{
      const v = qtyMap[ship.id] || '';
      const row=document.createElement('tr'); row.setAttribute('data-row-id', ship.id);
      const tdName = document.createElement('td'); tdName.style.textAlign = 'left';
      const img = document.createElement('img');
      img.src = "images/ships/" + ship.img;
      img.alt = state.lang === 'tr' ? (ship.tr || ship.ru) : (ship.ru || ship.tr);
      img.style.width='28px'; img.style.height='28px'; img.style.verticalAlign='middle'; img.style.marginRight='8px'; img.style.borderRadius='4px';
      img.loading = 'lazy';
      img.addEventListener('error', ()=>{
        if(!img._fallback){ const fb=createImageFallback(); img.style.display='none'; img.parentNode && img.parentNode.insertBefore(fb, img.nextSibling); img._fallback=true; }
      });
      const spanName = document.createElement('span'); spanName.className='ship-name'; spanName.textContent = state.lang === 'tr' ? (ship.tr || ship.ru) : (ship.ru || ship.tr);
      tdName.appendChild(img); tdName.appendChild(spanName); row.appendChild(tdName);

      const tdM = document.createElement('td'); tdM.appendChild(createSpanWithClass('val-metal', ship.metal)); row.appendChild(tdM);
      const tdC = document.createElement('td'); tdC.appendChild(createSpanWithClass('val-crystal', ship.crystal)); row.appendChild(tdC);
      const tdD = document.createElement('td'); tdD.appendChild(createSpanWithClass('val-deut', ship.deut)); row.appendChild(tdD);

      const tdQty = document.createElement('td'); const inQty = document.createElement('input'); inQty.type='text'; inQty.inputMode='numeric'; inQty.pattern='[0-9\\.]*'; inQty.value = v; inQty.dataset.id = ship.id;
      tdQty.appendChild(inQty); row.appendChild(tdQty);

      tableBody.appendChild(row);

      // register formatting for qty input
      registerInputFormatting(inQty);

      if(!inQty._qtyBound){
        inQty.addEventListener('change', ()=>{
          saveShipQuantities();
          computeFleet();
        });
        inQty._qtyBound = true;
      }
    });
  }

  // compute fleet using shipMap (O(n))
  function computeFleet(){
    const factorC = CONFIG.METAL_EQ_CRYSTAL;
    const factorD = CONFIG.METAL_EQ_DEUT;
    let totalM=0, totalC=0, totalD=0;
    document.querySelectorAll("input[data-id]").forEach(inp=>{
      const qty = toNumberSafe(inp.value, 0);
      if(qty <= 0) { inp.value = ''; return; }
      const ship = shipMap[inp.dataset.id];
      if(!ship) return;
      totalM += qty * ship.metal; totalC += qty * ship.crystal; totalD += qty * ship.deut;
      inp.value = formatNumber(qty);
    });

    const totalResEl = document.getElementById('totalRes'), totalMetalEqEl = document.getElementById('totalMetalEq'), grandTotalEl = document.getElementById('grandTotal');
    if(totalResEl){
      totalResEl.textContent = '';
      const mspan = createSpanWithClass('val-metal', totalM);
      const cspan = createSpanWithClass('val-crystal', totalC);
      const dspan = createSpanWithClass('val-deut', totalD);
      totalResEl.appendChild(mspan);
      totalResEl.appendChild(document.createTextNode(' ' + (LANG[state.lang].metal || 'Металл') + ', '));
      totalResEl.appendChild(cspan);
      totalResEl.appendChild(document.createTextNode(' ' + (LANG[state.lang].crystal || 'Кристалл') + ', '));
      totalResEl.appendChild(dspan);
      totalResEl.appendChild(document.createTextNode(' ' + (LANG[state.lang].deut || 'Дейтерий')));
    }
    const metalEq = Math.round(totalM + totalC * factorC + totalD * factorD);
    if(totalMetalEqEl) totalMetalEqEl.textContent = formatNumber(metalEq);

    const boxesCount = toNumberSafe(boxesCountInput?.value, 0);
    const boxValue = toNumberSafe(boxValueInput?.value, 0);
    const boxesMetal = boxesCount * boxValue;
    const planetM = toNumberSafe(document.getElementById('planetMetal')?.value, 0);
    const planetC = toNumberSafe(document.getElementById('planetCrystal')?.value, 0);
    const planetD = toNumberSafe(document.getElementById('planetDeut')?.value, 0);
    const planetMetalEq = planetM + planetC * factorC + planetD * factorD;
    const grand = boxesMetal + planetMetalEq - metalEq;
    if(grandTotalEl) { grandTotalEl.textContent = formatNumber(Math.round(grand)); grandTotalEl.style.color = grand>=0 ? "#41c879" : "#ff4d4d"; }

    const availableMetalPool = boxesMetal + planetMetalEq;
    let cumulativeEq = 0;
    document.querySelectorAll("#shipsTable tbody tr[data-row-id]").forEach(row=>{
      const id = row.getAttribute('data-row-id');
      const inp = row.querySelector('input[data-id]');
      const qty = toNumberSafe(inp?.value, 0);
      const ship = shipMap[id];
      let rowEq = 0;
      if(ship && qty > 0){
        const m = ship.metal * qty, c = ship.crystal * qty, d = ship.deut * qty;
        rowEq = m + c * factorC + d * factorD;
      }
      cumulativeEq += rowEq;
      if(availableMetalPool > 0 && rowEq > 0 && cumulativeEq > availableMetalPool) row.classList.add('row-deficit'); else row.classList.remove('row-deficit');
    });

    persistBoxesAndPlanets();
    saveShipQuantities();
    updateBoxesNeeded();
  }

  function updateBoxesNeeded(){
    const boxValue = toNumberSafe(boxValueInput?.value || '', 0);
    const targetMetal = getCurrentTotalMetalValue();
    if(!boxValue || boxValue <= 0){ boxesNeededEl && (boxesNeededEl.textContent='—'); boxesCostTLEl && (boxesCostTLEl.textContent = 'TRY: —'); return; }
    const needed = Math.ceil(targetMetal / boxValue);
    boxesNeededEl && (boxesNeededEl.textContent = formatNumber(needed));
    updateBoxesCostTL();
  }

  function getCurrentTotalMetalValue(){
    if(state.activeTab === 'buildings') return toNumberSafe(document.getElementById('sumTotalMetalB')?.textContent, 0);
    if(state.activeTab === 'research') return toNumberSafe(document.getElementById('sumTotalMetalR')?.textContent, 0);
    if(state.activeTab === 'fleet') return toNumberSafe(document.getElementById('totalMetalEq')?.textContent, 0);
    return 0;
  }

  function updateBoxesCostTL(){
    if(!boxesCostTLEl) return;
    const boxValue = toNumberSafe(boxValueInput?.value || '', 0);
    if(boxValue <= 0){ boxesCostTLEl.textContent = 'TRY: —'; return; }
    const targetMetalEq = getCurrentTotalMetalValue();
    const neededBoxes = Math.ceil(targetMetalEq / boxValue);
    if(neededBoxes <= 0){ boxesCostTLEl.textContent = 'TRY: 0'; return; }
    const requiredTM = neededBoxes * CONFIG.TM_PER_BOX;
    const pack = CONFIG.TM_PACKS[0];
    const packsCount = Math.max(1, Math.ceil(requiredTM / pack.tm));
    const totalTRY = packsCount * (pack.priceTRY || 0);
    const leftoverTM = packsCount * pack.tm - requiredTM;
    const leftoverLabel = LANG[state.lang]?.leftoverLabel || 'Остаток ТМ';
    boxesCostTLEl.textContent = '';
    const spanTRY = document.createElement('span'); spanTRY.className='try-value'; spanTRY.textContent = 'TRY: ' + formatNumber(totalTRY);
    boxesCostTLEl.appendChild(spanTRY);
    if(leftoverTM > 0){
      boxesCostTLEl.appendChild(document.createTextNode(' '));
      const spanLeft = document.createElement('span'); spanLeft.className='tm-left'; spanLeft.textContent = leftoverLabel + ': ' + formatNumber(leftoverTM);
      boxesCostTLEl.appendChild(spanLeft);
    }
  }

  function resetAllValues(){
    document.querySelectorAll('#tbodyBuildings input[data-type], #tbodyResearch input[data-type]').forEach(inp=>{ inp.value = ''; });
    if(boxesCountInput) boxesCountInput.value = '';
    if(boxValueInput) boxValueInput.value = '';
    ['planetMetal','planetCrystal','planetDeut'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value = ''; });
    document.querySelectorAll('input[data-id]').forEach(inp=> inp.value = '');
    if(tmInput) tmInput.value = '';
    ['sumMetalB','sumCrystalB','sumDeutB','sumPointsB','sumTotalMetalB','sumMetalR','sumCrystalR','sumDeutR','sumPointsR','sumTotalMetalR','totalRes','totalMetalEq','grandTotal'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.textContent = '0';
    });
    document.getElementById('boxesNeeded') && (document.getElementById('boxesNeeded').textContent = '0');
    document.getElementById('boxesCostTL') && (document.getElementById('boxesCostTL').textContent = 'TRY: —');

    try{ Object.values(KEYS).forEach(k => localStorage.removeItem(k)); }catch(e){}
    attachLiveThousandsFormatting('#boxesCount, #boxValue, #planetMetal, #planetCrystal, #planetDeut, input[data-id]');
    renderTable();
    computeFleet();
    recalcAllBuildings();
    recalcAllResearch();
    updateBoxesCostTL();
  }

  function attachInputsHandlers(){
    const debouncedRecalcBuildings = debounce(recalcAllBuildings, 120);
    const debouncedRecalcResearch = debounce(recalcAllResearch, 120);
    const debouncedComputeFleet = debounce(computeFleet, 120);

    tbodyB.addEventListener('input', e=>{ const t=e.target; if(!(t.matches('.lvl-input')||t.matches('.planet-input'))) return; debouncedRecalcBuildings(); });
    tbodyB.addEventListener('change', e=>{ persistInputs('buildings'); debouncedRecalcBuildings(); });

    tbodyR.addEventListener('input', e=>{ const t=e.target; if(!t.matches('.lvl-input')) return; debouncedRecalcResearch(); });
    tbodyR.addEventListener('change', e=>{ persistInputs('research'); debouncedRecalcResearch(); });

    tmInput && tmInput.addEventListener('input', ()=>{ const v = toNumberSafe(tmInput.value, 0); state.tmPrice = v; saveToLS(KEYS.TM, v); debouncedRecalcResearch(); });
    tmInput && tmInput.addEventListener('blur', ()=>{ const v = toNumberSafe(tmInput.value, 0); state.tmPrice = v; tmInput.value = v ? String(v) : ''; saveToLS(KEYS.TM, v); debouncedRecalcResearch(); });

    boxesCountInput && boxesCountInput.addEventListener('change', ()=>{ persistBoxesAndPlanets(); debouncedComputeFleet(); });
    boxValueInput && boxValueInput.addEventListener('change', ()=>{ persistBoxesAndPlanets(); debouncedComputeFleet(); });
    document.getElementById('planetMetal')?.addEventListener('change', ()=>{ persistBoxesAndPlanets(); debouncedComputeFleet(); });
    document.getElementById('planetCrystal')?.addEventListener('change', ()=>{ persistBoxesAndPlanets(); debouncedComputeFleet(); });
    document.getElementById('planetDeut')?.addEventListener('change', ()=>{ persistBoxesAndPlanets(); debouncedComputeFleet(); });
  }

  function debounce(fn, wait) { let t=null; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; }

  // transform state
  window.scale = state.transform?.scale || 1;
  window.posX = state.transform?.posX || 0;
  window.posY = state.transform?.posY || 0;

  function applyTransform(){ wrapperEl.style.transform = `translate(${window.posX}px, ${window.posY}px) scale(${window.scale})`; /* save is handled separately */ }
  function saveTransform(){ saveToLS(KEYS.TRANSFORM, { scale: window.scale, posX: window.posX, posY: window.posY }); }

  // zoom math
  function doZoom(delta, centerX = window.innerWidth/2, centerY = window.innerHeight/2){
    const oldScale = window.scale; const factor = Math.pow(1.2, delta); const newScale = Math.max(0.4, Math.min(3.5, window.scale * factor));
    const rect = wrapperEl.getBoundingClientRect(); const cx = centerX - rect.left; const cy = centerY - rect.top;
    window.posX -= (cx / oldScale) * (newScale - oldScale) / newScale;
    window.posY -= (cy / oldScale) * (newScale - oldScale) / newScale;
    window.scale = newScale; applyTransform(); saveTransform();
  }
  function centerWrapperAtCurrentScale(){ const el = wrapperEl; if(!el) return; const unscaledW = el.offsetWidth, unscaledH = el.offsetHeight; const desiredLeft = Math.round((window.innerWidth - unscaledW * window.scale)/2); const desiredTop = Math.round((window.innerHeight - unscaledH * window.scale)/2); window.posX = desiredLeft / window.scale; window.posY = desiredTop / window.scale; applyTransform(); saveTransform(); }

  // improved drag using rAF for transform updates and saving only on pointerup
  (function attachDragFix(){
    const dragHandle = document.getElementById('dragHandle'); const wrapper = document.getElementById('tableWrapper'); if(!dragHandle || !wrapper) return;
    let dragging=false, startX=0, startY=0, startPosX=0, startPosY=0;
    let rafId = 0;
    dragHandle.style.touchAction='none';

    dragHandle.addEventListener('pointerdown', ev=>{
      ev.preventDefault(); dragging=true; startX=ev.clientX; startY=ev.clientY; startPosX = window.posX || 0; startPosY = window.posY || 0;
      try{ dragHandle.setPointerCapture(ev.pointerId); }catch{}
      dragHandle.style.cursor='grabbing';
    });

    document.addEventListener('pointermove', ev=>{
      if(!dragging) return;
      ev.preventDefault();
      const dx = (ev.clientX - startX) / (window.scale || 1);
      const dy = (ev.clientY - startY) / (window.scale || 1);
      window.posX = startPosX + dx;
      window.posY = startPosY + dy;
      if(rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(()=>{
        wrapper.style.transform = `translate(${window.posX}px, ${window.posY}px) scale(${window.scale})`;
      });
    });

    function stopDrag(ev){
      if(!dragging) return;
      dragging=false;
      try{ dragHandle.releasePointerCapture && dragHandle.releasePointerCapture(ev && ev.pointerId); }catch{}
      dragHandle.style.cursor='grab';
      // save once after end
      saveTransform();
    }
    document.addEventListener('pointerup', stopDrag);
    document.addEventListener('pointercancel', stopDrag);
    dragHandle.addEventListener('keydown', e=>{
      const step=10;
      if(e.key==='ArrowLeft'){ window.posX = (window.posX||0) - step; }
      if(e.key==='ArrowRight'){ window.posX = (window.posX||0) + step; }
      if(e.key==='ArrowUp'){ window.posY = (window.posY||0) - step; }
      if(e.key==='ArrowDown'){ window.posY = (window.posY||0) + step; }
      wrapper.style.transform = `translate(${window.posX}px, ${window.posY}px) scale(${window.scale})`;
      saveTransform();
    });
    dragHandle.style.cursor='grab';
  })();

  function setActiveTab(tab){
    state.activeTab = tab; saveToLS(KEYS.ACTIVE_TAB, tab);
    document.querySelectorAll(' .tab-btn').forEach(b=>{ const is=b.dataset.tab===tab; b.classList.toggle('active', is); b.setAttribute('aria-selected', String(is)); });
    const panels={ buildings: document.getElementById('tabBuildings'), research: document.getElementById('tabResearch'), fleet: document.getElementById('tabFleet') };
    Object.keys(panels).forEach(k=>{ const el=panels[k]; if(!el) return; const show = k===tab; el.classList.toggle('active', show); el.setAttribute('aria-hidden', String(!show)); });
    const panel = panels[tab];
    if(panel){ const firstFocusable = panel.querySelector('input, button, [tabindex]:not([tabindex="-1"])'); if(firstFocusable) try{ firstFocusable.focus(); }catch(e){} }
    if(tab==='fleet'){ document.getElementById('fleetDelivery').style.display = 'flex'; renderTable(); computeFleet(); } else { document.getElementById('fleetDelivery').style.display = 'none'; if(tab==='buildings') recalcAllBuildings(); else if(tab==='research') recalcAllResearch(); }
    updateBoxesNeeded();
  }
  document.querySelectorAll('.tab-btn').forEach(btn=> btn.addEventListener('click', ()=> setActiveTab(btn.dataset.tab) ));

  // applyLang: rebuild rows and re-render, but do not call restoreAll inside to avoid overwriting transient inputs
  function applyLang(lang){
    if(!lang || (lang!=='ru' && lang!=='tr')) return;
    state.lang = lang; saveToLS(KEYS.LANG, lang);
    buildRowsBuildings();
    buildRowsResearch();
    const dict = LANG[lang] || LANG.ru;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n'); if(key && dict[key] !== undefined) el.textContent = dict[key];
    });
    document.querySelectorAll('[data-key]').forEach(el=>{
      const key = el.dataset.key; const label = el.querySelector('.data-key-label'); if(label && dict[key] !== undefined) label.textContent = dict[key];
    });
    document.getElementById('tmLabel') && (document.getElementById('tmLabel').textContent = dict.tmLabel || document.getElementById('tmLabel').textContent);
    if (boxesCountInput) boxesCountInput.placeholder = dict.boxesCountPh || boxesCountInput.placeholder;
    if (boxValueInput) boxValueInput.placeholder = dict.boxValuePh || boxValueInput.placeholder;
    document.getElementById('langRU').classList.toggle('active', lang==='ru');
    document.getElementById('langTR').classList.toggle('active', lang==='tr');
    renderTable();
    attachInputsHandlers();
    recalcAllBuildings();
    recalcAllResearch();
    computeFleet();
  }
  document.getElementById('langRU').addEventListener('click', ()=> applyLang('ru'));
  document.getElementById('langTR').addEventListener('click', ()=> applyLang('tr'));

  document.addEventListener('DOMContentLoaded', ()=>{
    const zin = document.getElementById('globalZoomIn'), zout = document.getElementById('globalZoomOut'), zreset = document.getElementById('globalZoomReset');
    zin && zin.addEventListener('click', ()=> doZoom(1, window.innerWidth/2, window.innerHeight/2));
    zout && zout.addEventListener('click', ()=> doZoom(-1, window.innerWidth/2, window.innerHeight/2));
    zreset && zreset.addEventListener('click', ()=> {
      window.scale = 1; window.posX = 0; window.posY = 0; applyTransform();
      centerWrapperAtCurrentScale();
      saveTransform();
      resetAllValues();
    });
  });

  function initCore(){
    buildShipMap();
    buildRowsBuildings(); buildRowsResearch();
    attachLiveThousandsFormatting('#boxesCount, #boxValue, #planetMetal, #planetCrystal, #planetDeut');
    attachInputsHandlers();
    renderTable();
    restoreAll(); // restore after rendering base DOM
    // applyLang should rebuild rows and not overwrite user inputs restored above; call applyLang to localize labels only
    const curLang = state.lang || 'ru';
    // apply textual localization and re-render labels (does not call restoreAll)
    applyLang(curLang);
    // now re-apply restored values into new inputs (restoreAll called earlier)
    const tr = loadFromLS(KEYS.TRANSFORM, null);
    if(tr && typeof tr.scale === 'number'){ window.scale = tr.scale; window.posX = tr.posX || 0; window.posY = tr.posY || 0; applyTransform(); }
    setActiveTab(state.activeTab || 'buildings');
    // ensure qty inputs have formatting and listeners
    attachLiveThousandsFormatting('input[data-id]');
    document.querySelectorAll('input[data-id]').forEach(inp=>{
      if(!inp._qtyBound){
        inp.addEventListener('change', ()=>{ saveShipQuantities(); computeFleet(); });
        inp._qtyBound = true;
      }
    });
    computeFleet();
    recalcAllBuildings();
    recalcAllResearch();
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initCore); else initCore();

})();
  </script>
</body>
</html>
